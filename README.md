# .NET Core REST Api for Role Playing Game(rpg)

Demo: [https://net-rpg.herokuapp.com/](https://net-rpg.herokuapp.com/)
## Installation

If you wanna try run quickly this project from your local:
- Clone this repo
- Run `dotnet restore` to update packages dependencies
- Set user-secrets for secret key database
  ```s
  dotnet user-secrets init
  dotnet user-secrets set "AppSettings:Token" "< any secret key for jsonwebtoken>"
  ```
- Change name & password for connectionString of PostgreSQL in `appSettings.json`
  ```json
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost; Port=5432; Database=net_todo; User ID=postgres; Password=postgres"
  }
  ```
- Run database seeding
  ```s
  dotnet tool install -g dotnet-ef
  dotnet ef database update
  dotnet run
  ```
- Run `dotnet run`: to run server (check on port 5000)

Note: In this project, I use .Net version `3.1.3` and `5.0`. If you don't use these versions. You can use your own version by change version in `global.json` file and specify it in `.csproj` file: `<TargetFramework>netcoreapp3.1</TargetFramework>`.
## Development

This project shows: 
  - How to build a web REST API with .net core 3 or  5
  - How to have a good structure project for web api
  - How to use SQL Database, SQL Relationship & Entity Framework
  - How to secure app & authenticate with JsonWebToken
  - How to practice OOP Solution C# 
  - How to map & convert quickly between different classes
  - How to create document API with Swagger/Open API
  - How to use Dependency Injection solution
  - How to access User from `HttpContextAccessor`
  - How to use asynchronously development solution for your project
  - How to use Generic type
  

### Technologies
- Dotnet web api
- Authentication user: Using `System.Security.Cryptography` algorithms to create password `hash` & `salt` to save in database.
- Database: using `PostgreSQL` & Microsoft Entity Framework
- Authentication HTTP request with Json Web Token
- AutoMapper data between `data models` &  `data transfer object`
- Documentation: Using `Swashbuckle` of swagger to generate auto document api for view controller.

### Structure folder

- **Controllers**: contains all view controllers of project (routes, http request)
- **Data**: contains DataContext of Entity Framework Database
- **Dto**: Data Transfer Objects - Classes used as a container to encapsulate data and pass it from one layer of the application to another. We usually use them for working with http request.
- **Migrations**: Folders generate auto by [ef tool](https://docs.microsoft.com/en-us/ef/core/cli/dotnet) to create migrations with sql database (like PostgreSQL, MySQL, SQL Server ...)
- **Models**: Class models contain fields of database tables
- **Services**: All services of project. Each service is equivalent the controller. It contains all methods using for controller.
- **Utilities**: Helper methods
- All other files: Generate auto with `dotnet new` tool.
  

### Branches
I follow the principle development given by [Patrick God](https://dev.to/_patrickgod) and I try my own to code solution project.

  Thanks so much of his contribution. The series of this development are posted on [dev.to](https://dev.to/_patrickgod/net-core-3-1-web-api-entity-framework-jumpstart-part-1-4jla). 

The project is developed step by step from basics to advance.

Each branch is equivalent to each step. The master branch is the last solution of project. The template project is generated by `dotnet new webapi -o <...>`

Step by step: basic to advance --> branch by branch:

- s1: Basic setup & Init  project with Entity Framework
- s2: Routing & Http request
- s3: Using asynchronous call
- s4: Using Data transfer object (DTO)
- s5: Object relation mapping & Migration with SQL database
- s6: CRUD with Entity Framework
- s7: Basic authentication
- s8: Authentication with JsonWebToken
- s9: Init relationship between models
- s10: One to one relationship
- s11: One to many relationship
- s12: Create Fight Classes for game
- s14: User role
- s15: Create seeding for Init database
- s16: More: Skill routing
- s17: More: User routing
- s18: Deploy to heroku
- Master branch: Latest solution
- Upgrade-net50 branch: Using .Net 5.0
  
Todo:
- [x] Fix database production on heroku
- [ ] Unit Testing

## Deploy production on Heroku
[Heroku](https://www.heroku.com/home) is free for 5 app forever. Azure cloud is free only for first year. I decided use heroku for deploy API server of this project.

Because Heroku isn't able to run C# code directly, but they do have supprot for Docker container. So we will create Docker container and push it to Heroku container.

- Make sure you have an heroku account, [heroku cli](https://devcenter.heroku.com/articles/heroku-cli) & docker installed on your local
- Login heroku account from browser
- Login heroku account with heroku cli
  ```s
  $ heroku login
  $ heroku container:login
  # Press any key & click button login when a web page of heroku opened
  ```
- Create a app from your heroku account
  For example: I created a app called `net-rpg`
  
  We will use this app later to deploy with Docker container
- Create `Dockerfile` & paste the following code:
  ```yml
  # Dockerfile
  FROM mcr.microsoft.com/dotnet/core/sdk:3.1 AS build-env
  WORKDIR /app

  # Copy csproj and restore as distinct layers
  COPY *.csproj ./
  RUN dotnet restore


  # Copy everything else and build
  COPY . .
  RUN dotnet publish -c Release -o out

  # Build runtime image
  FROM mcr.microsoft.com/dotnet/core/aspnet:3.1
  WORKDIR /app
  COPY --from=build-env /app/out .

  # Run the app on container startup
  # Use your project name for the second parameter
  # e.g. MyProject.dll
  # ENTRYPOINT [ "dotnet", "Rpg_Restapi.dll" ]
  CMD ASPNETCORE_URLS=http://*:$PORT dotnet Rpg_Restapi.dll
  ```
- Create `.dockerignore` to ignore debug & test file
  ```
  # .dockerignore file
  bin/
  obj/
  ```
- Push your app to heroku container
  
  As I created a app called `net-rpg`, I will use it now:
  ```s
  $ heroku container:push -a net-rpg web
  ```
- Release deploy
  ```s
  $ heroku container:release -a net-rpg web
  ```
- Check link app from heroku
## Reference

Best thank Patrick God for awesome series [Web API Entity Framework .Net core](https://dev.to/_patrickgod/net-core-3-1-web-api-entity-framework-jumpstart-part-1-4jla)

